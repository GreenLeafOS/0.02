/*===============================================================
 *                       ldt.c
 *                	  LDT相关处理函数
 ===============================================================*/
#include "include/table.h"

/************************************************************************/
/*							数据区
/************************************************************************/
Desc	ldt_table[8];
u8 		ldt_ptr[6];

/************************************************************************/
/*							初始化
/*                           init
/************************************************************************/
void ldt_init()
{
	return;
}

/************************************************************************/
/*					   ldt操作（针对临时缓冲区）
/*                            ldt
/************************************************************************/


/****************************
 * 添加
 * avl标志位为1则为占用，为0则空闲
 ****************************/
int ldt_add(Desc item)
{
	for(int i=1;i<8;i++)
	{
		Desc* buf = &ldt_table[i];
		if (!(buf->avl))
		{
			ldt_set(i,item);
			return i;
		}
	}
	return -1;
}



/****************************
 * 删除
 * 清除avl位即可
 ****************************/
void ldt_remove(int index)
{
	Desc* buf = &ldt_table[index];
	buf->avl = 0;
}



/****************************
 * 修改项
 ****************************/
void ldt_set(int index,Desc item)
{
	Desc* buf = &ldt_table[index];
	*buf = item;
	buf->avl = 1;
}



/****************************
 * 读取项
 ****************************/
void ldt_get(int index,Desc *item)
{
	Desc* buf = &ldt_table[index];
	*item = *buf;
}



/************************************************************************/
/*					 		加载 ldt
/*                            ldt
/************************************************************************/
void ldt_load()
{
	u16* p_ldt_limit = (u16*)(&ldt_ptr[0]);
	u32* p_ldt_base  = (u32*)(&ldt_ptr[2]);
	char *pLdt = (char*)&ldt_ptr[0];

	*p_ldt_limit = 8 * sizeof(Desc) - 1;
	*p_ldt_base  = (u32)&ldt_table[0];

	__asm volatile(
			"movl %0,%%eax		\n"
			"lldt (%%eax)"
			:
			: "g"(pLdt));
}

